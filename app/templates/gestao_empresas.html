{% extends 'base.html' %}

{% block title %}
    Gestão de Empresas Parceiras
{% endblock %}

{% block content %}
    <h1>Empresas</h1>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    <div class="action-buttons">
        <a href="{% url 'manguetown:cadastro_empresa' %}" class="button">Cadastrar nova Empresa</a>
        <a href="{% url 'manguetown:dashboard' %}" class="button">Voltar para Painel Administrativo</a>
    </div>

    <table>
        <thead>
            <tr>
                <th>Nome do Responsável</th>
                <th>Nome da Empresa</th>
                <th>Local de Captação</th>
                <th>Disponibilidade para pegar o resíduo</th>
                <th>Porte de Fabricação</th>
                <th>Tipo de Resíduo</th>
                <th>Condição do Resíduo</th>
                <th>Ações</th> <!-- Coluna para ações -->
            </tr>
        </thead>
        <tbody>
            {% for empresa in empresas %}
            <tr>
                <td>{{ empresa.nome_responsavel }}</td>
                <td>{{ empresa.nome_empresa }}</td>
                <td>{{ empresa.captacao_local }}</td>
                <td>{{ empresa.disponibilidade_residuo }}</td>
                <td>{{ empresa.porte_fabrico }}</td>
                <td>{{ empresa.tipo_residuo }}</td>
                <td>{{ empresa.condicao_residuo }}</td>
                <td>
                    <!-- Dropdown para ações -->
                    <select class="action-select" data-empresa-id="{{ empresa.id }}">
                        <option value="">Escolha ação</option>
                        <option value="editar">Editar</option>
                        <option value="excluir">Excluir</option>
                    </select>
                </td> 
            </tr>
            {% empty %}
            <tr>
                <td colspan="8">Nenhuma empresa cadastrada.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.action-select').forEach(select => {
                select.addEventListener('change', function() {
                    const action = this.value;
                    const empresaId = this.getAttribute('data-empresa-id'); // Obtém o ID da empresa

                    if (action === 'excluir') {
                        // Confirmação antes de excluir
                        if (confirm("Tem certeza de que deseja excluir esta empresa?")) {
                            // Cria e envia um formulário para excluir
                            const form = document.createElement('form');
                            form.method = 'POST';
                            form.action = "{% url 'manguetown:gestao_empresas' %}"; // Atualize para a URL correta
                            form.style.display = 'none';

                            // CSRF token
                            const csrfToken = document.createElement('input');
                            csrfToken.type = 'hidden';
                            csrfToken.name = 'csrfmiddlewaretoken';
                            csrfToken.value = "{{ csrf_token }}";
                            form.appendChild(csrfToken);

                            // ID da empresa
                            const input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = 'empresa_id';
                            input.value = empresaId;
                            form.appendChild(input);

                            document.body.appendChild(form);
                            form.submit();
                        }
                    } else if (action === 'editar') {
                        if (empresaId) {
                            window.location.href = "{% url 'manguetown:editar_empresa' '0' %}".replace("0", empresaId);
                        } else {
                            alert("Selecione uma empresa válida para editar.");
                        }
                    }

                    // Resetar o dropdown após uma ação
                    this.value = "";
                });
            });
        });
    </script>

{% endblock %}
